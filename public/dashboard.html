<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InterTand - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-white shadow border-b">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-900">InterTand Dashboard</h1>
            <div class="flex items-center space-x-4">
                <span id="userName" class="text-gray-600"></span>
                <button onclick="logout()" class="text-red-600 hover:underline">Salir</button>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 py-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded shadow">
                <h3 class="text-lg font-semibold text-gray-700">Tandas</h3>
                <p class="text-3xl font-bold text-blue-600" id="totalTandas">0</p>
            </div>
            <div class="bg-white p-6 rounded shadow">
                <h3 class="text-lg font-semibold text-gray-700">Mi Turno</h3>
                <p class="text-3xl font-bold text-purple-600" id="miTurno">-</p>
            </div>
            <div class="bg-white p-6 rounded shadow">
                <h3 class="text-lg font-semibold text-gray-700">Mi Saldo</h3>
                <p class="text-3xl font-bold text-green-600" id="totalInvertido">$0</p>
            </div>
            <div class="bg-white p-6 rounded shadow">
                <h3 class="text-lg font-semibold text-gray-700">Pendientes</h3>
                <p class="text-3xl font-bold text-orange-600" id="pagosPendientes">0</p>
            </div>
        </div>

        <div class="bg-white rounded shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Nueva Tanda</h2>
            <form onsubmit="createTanda(event)" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                    <input type="text" id="tandaName" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Monto Total</label>
                    <input type="number" id="totalAmount" required min="1000"
                           class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Participantes</label>
                    <input type="number" id="maxParticipants" required min="3" max="20"
                           class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Periodo</label>
                    <select id="period" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Seleccionar periodo</option>
                        <option value="semanal">Semanal</option>
                        <option value="quincenal">Quincenal</option>
                        <option value="mensual">Mensual</option>
                    </select>
                </div>
                <div class="md:col-span-4">
                    <button type="submit" 
                            class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                        Crear Tanda
                    </button>
                </div>
            </form>
        </div>

        <div class="bg-white rounded shadow">
            <div class="p-6 border-b">
                <h2 class="text-xl font-semibold">Tandas Disponibles</h2>
            </div>
            <div id="tandasList" class="divide-y">
            </div>
        </div>

        <div class="bg-white rounded shadow mt-8">
            <div class="p-6 border-b">
                <h2 class="text-xl font-semibold">Historial de Pagos</h2>
            </div>
            <div id="paymentsList" class="divide-y">
            </div>
        </div>
    </div>

    <div id="message" class="hidden fixed top-4 right-4 p-4 rounded shadow-lg z-50"></div>

    <!-- Modal para seleccionar turno -->
    <div id="turnModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Selecciona tu turno</h3>
                <div class="mt-2 px-7 py-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Turnos disponibles:</label>
                    <select id="modalTurnSelect" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Seleccionar turno</option>
                    </select>
                    <p class="text-sm text-gray-500 mt-2">Una vez seleccionado, no podr√°s cambiarlo</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirmTurnBtn" onclick="confirmTurnSelection()" 
                            class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300 mr-2">
                        Confirmar
                    </button>
                    <button onclick="closeTurnModal()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 text-base font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ver participantes -->
    <div id="participantsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 text-center mb-4">Participantes de la Tanda</h3>
                <div id="participantsList" class="max-h-64 overflow-y-auto space-y-2">
                    <!-- Participants will be populated dynamically -->
                </div>
                <div class="text-center mt-4">
                    <button onclick="closeParticipantsModal()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 text-base font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let tandas = [];
        let payments = [];

        document.addEventListener('DOMContentLoaded', function() {
            const userData = localStorage.getItem('user');
            if (!userData) {
                window.location.href = '/';
                return;
            }
            
            currentUser = JSON.parse(userData);
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('miTurno').textContent = currentUser.turno || 'Sin asignar';
            
            loadTandas();
            loadPayments();
        });

        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        // Variables globales para el modal
        let currentTandaId = null;

        function showMessage(text, type = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `fixed top-4 right-4 p-4 rounded shadow-lg z-50 ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            messageDiv.classList.remove('hidden');
            
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 3000);
        }

        async function createTanda(event) {
            event.preventDefault();
            
            const name = document.getElementById('tandaName').value;
            const total_amount = parseInt(document.getElementById('totalAmount').value);
            const max_participants = parseInt(document.getElementById('maxParticipants').value);
            const period = document.getElementById('period').value;
            
            if (!period) {
                showMessage('Por favor selecciona un periodo', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/tandas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        total_amount,
                        max_participants,
                        period
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message);
                    document.getElementById('tandaName').value = '';
                    document.getElementById('totalAmount').value = '';
                    document.getElementById('maxParticipants').value = '';
                    document.getElementById('period').value = '';
                    loadTandas();
                } else {
                    showMessage(data.error || 'Error al crear tanda', 'error');
                }
            } catch (error) {
                showMessage('Error de conexi√≥n', 'error');
            }
        }

        async function loadTandas() {
            try {
                const response = await fetch('/api/tandas');
                const data = await response.json();
                tandas = data.tandas || [];
                
                document.getElementById('totalTandas').textContent = tandas.length;
                
                const container = document.getElementById('tandasList');
                if (tandas.length === 0) {
                    container.innerHTML = '<div class="p-6 text-gray-500 text-center">No hay tandas disponibles</div>';
                } else {
                    // Verificar participaci√≥n del usuario en cada tanda
                    const tandasWithStatus = await Promise.all(tandas.map(async (tanda) => {
                        try {
                            const statusResponse = await fetch(`/api/tandas/${tanda.id}/user-status/${currentUser.id}`);
                            const statusData = await statusResponse.json();
                            return { ...tanda, userStatus: statusData };
                        } catch (error) {
                            return { ...tanda, userStatus: { isParticipant: false, turnOrder: null } };
                        }
                    }));
                    
                    container.innerHTML = tandasWithStatus.map(tanda => {
                        const isCurrentTurn = currentUser.id === tanda.current_user_id;
                        const montoIndividual = tanda.total_amount / tanda.max_participants;
                        const isParticipant = tanda.userStatus.isParticipant;
                        
                        return `
                        <div class="p-6">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-lg">${tanda.name}</h3>
                                    <div class="mt-2 space-y-1">
                                        <p class="text-sm">Monto Total: $${tanda.total_amount.toLocaleString()}</p>
                                        <p class="text-sm">Acumulado: $${(tanda.current_amount || 0).toLocaleString()}</p>
                                        <p class="text-sm">Participantes: ${tanda.max_participants}</p>
                                        <p class="text-sm">Pago ${tanda.period}: $${montoIndividual.toLocaleString()}</p>
                                        <p class="text-sm">Turno actual: ${tanda.current_turn} ${tanda.current_user_name ? `(${tanda.current_user_name})` : ''}</p>
                                        <p class="text-sm">Periodo: <span class="capitalize">${tanda.period}</span></p>
                                        ${isParticipant ? `<p class="text-sm font-bold text-blue-600">‚úÖ Participas - Turno ${tanda.userStatus.turnOrder}</p>` : ''}
                                        ${isCurrentTurn ? '<p class="text-sm font-bold text-green-600">üéâ ¬°Es tu turno de recibir!</p>' : ''}
                                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                            <div class="bg-blue-600 h-2 rounded-full" 
                                                 style="width: ${((tanda.current_amount || 0) / tanda.total_amount) * 100}%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="ml-4 space-y-2">
                                    ${!isParticipant ? 
                                        `<button onclick="openTurnModal(${tanda.id})" 
                                                class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 block w-full">
                                            Unirse
                                        </button>` :
                                        '<button disabled class="bg-gray-400 text-white px-3 py-1 rounded text-sm block w-full cursor-not-allowed">Ya participas</button>'
                                    }
                                    ${!isParticipant ?
                                        '<button disabled class="bg-gray-300 text-gray-500 px-3 py-1 rounded text-sm block w-full cursor-not-allowed">Pagar</button>' :
                                        (isCurrentTurn ? 
                                            '<button disabled class="bg-gray-400 text-white px-3 py-1 rounded text-sm block w-full cursor-not-allowed">Tu turno - No puedes pagar</button>' :
                                            `<button onclick="createPayment(${tanda.id}, ${montoIndividual})" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 block w-full">Pagar $${montoIndividual.toLocaleString()}</button>`
                                        )
                                    }
                                    ${!isParticipant ?
                                        '<button disabled class="bg-gray-300 text-gray-500 px-3 py-1 rounded text-sm block w-full cursor-not-allowed">Ver</button>' :
                                        `<button onclick="viewParticipants(${tanda.id})" 
                                                class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700 block w-full">
                                            Ver
                                        </button>`
                                    }
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                showMessage('Error cargando tandas', 'error');
            }
        }

        async function loadPayments() {
            try {
                const response = await fetch(`/api/payments/${currentUser.id}`);
                const data = await response.json();
                payments = data.payments || [];
                
                const pendingCount = payments.filter(p => p.status === 'pending').length;
                document.getElementById('pagosPendientes').textContent = pendingCount;
                
                // Mostrar el saldo del usuario actual
                if (currentUser && currentUser.saldo !== undefined) {
                    document.getElementById('totalInvertido').textContent = `$${currentUser.saldo.toLocaleString()}`;
                } else {
                    document.getElementById('totalInvertido').textContent = '$0';
                }
                
                const container = document.getElementById('paymentsList');
                if (payments.length === 0) {
                    container.innerHTML = '<div class="p-6 text-gray-500 text-center">No hay pagos registrados</div>';
                } else {
                    container.innerHTML = payments.map(payment => `
                        <div class="p-4 hover:bg-gray-50">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-medium">${payment.tanda_name}</p>
                                    <p class="text-sm text-gray-600">${payment.type} - $${payment.amount.toLocaleString()}</p>
                                    <p class="text-xs text-gray-500">${new Date(payment.created_at).toLocaleDateString()}</p>
                                </div>
                                <span class="px-2 py-1 rounded text-xs font-medium ${
                                    payment.status === 'completed' ? 'bg-green-100 text-green-800' :
                                    payment.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                    'bg-red-100 text-red-800'
                                }">
                                    ${payment.status}
                                </span>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                showMessage('Error cargando pagos', 'error');
            }
        }

        async function createPayment(tandaId, suggestedAmount) {
            const amount = prompt(`Ingresa el monto del pago (sugerido: $${suggestedAmount.toLocaleString()}):`, suggestedAmount);
            if (!amount || isNaN(amount)) return;
            
            if (parseFloat(amount) <= 0) {
                showMessage('El monto debe ser mayor a cero', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/payments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tanda_id: tandaId,
                        user_id: currentUser.id,
                        amount: parseFloat(amount),
                        type: 'contribution'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('Pago registrado exitosamente');
                    loadPayments();
                    loadTandas(); // Recargar para ver el progreso actualizado
                } else {
                    showMessage(data.error || 'Error al registrar pago', 'error');
                }
            } catch (error) {
                showMessage('Error de conexi√≥n', 'error');
            }
        }

        async function openTurnModal(tandaId) {
            currentTandaId = tandaId;
            
            try {
                // Obtener turnos disponibles
                const response = await fetch(`/api/tandas/${tandaId}/available-turns`);
                const data = await response.json();
                
                if (data.availableTurns.length === 0) {
                    showMessage('No hay turnos disponibles en esta tanda', 'error');
                    return;
                }
                
                // Llenar el combobox con turnos disponibles
                const select = document.getElementById('modalTurnSelect');
                select.innerHTML = '<option value="">Seleccionar turno</option>';
                
                data.availableTurns.forEach(turn => {
                    const option = document.createElement('option');
                    option.value = turn;
                    option.textContent = `Turno ${turn}`;
                    select.appendChild(option);
                });
                
                // Mostrar el modal
                document.getElementById('turnModal').classList.remove('hidden');
            } catch (error) {
                showMessage('Error obteniendo turnos disponibles', 'error');
            }
        }

        function closeTurnModal() {
            document.getElementById('turnModal').classList.add('hidden');
            document.getElementById('modalTurnSelect').value = '';
            currentTandaId = null;
        }

        async function confirmTurnSelection() {
            const selectedTurn = parseInt(document.getElementById('modalTurnSelect').value);
            
            if (!selectedTurn) {
                showMessage('Por favor selecciona un turno', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/tandas/${currentTandaId}/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        selected_turn: selectedTurn
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`Te has unido exitosamente. Tu turno es: ${data.turnOrder}`);
                    // Actualizar el turno del usuario en la interfaz
                    currentUser.turno = data.turnOrder;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    document.getElementById('miTurno').textContent = data.turnOrder;
                    closeTurnModal();
                    loadTandas();
                } else {
                    showMessage(data.error || 'Error al unirse a la tanda', 'error');
                }
            } catch (error) {
                showMessage('Error de conexi√≥n', 'error');
            }
        }

        // Funci√≥n legacy - ya no se usa directamente, ahora se usa openTurnModal
        async function joinTanda(tandaId) {
            openTurnModal(tandaId);
        }

        async function viewParticipants(tandaId) {
            try {
                const [participantsResponse, turnsResponse] = await Promise.all([
                    fetch(`/api/tandas/${tandaId}/participants`),
                    fetch(`/api/tandas/${tandaId}/available-turns`)
                ]);
                
                const participantsData = await participantsResponse.json();
                const turnsData = await turnsResponse.json();
                
                if (participantsData.participants && turnsData) {
                    const participantsList = document.getElementById('participantsList');
                    
                    // Crear HTML para participantes
                    let participantsHTML = participantsData.participants.map(p => 
                        `<div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span class="font-medium">Turno ${p.turn_order}: ${p.name}</span>
                            <span class="text-sm ${p.has_received ? 'text-green-600' : 'text-orange-600'}">
                                ${p.has_received ? '‚úÖ Cobrado' : '‚è≥ Pendiente'}
                            </span>
                        </div>`
                    ).join('');
                    
                    // Agregar turnos disponibles si los hay
                    if (turnsData.availableTurns.length > 0) {
                        participantsHTML += `
                            <div class="mt-4 p-2 bg-blue-50 rounded">
                                <h4 class="font-medium text-blue-800 mb-2">Turnos Disponibles:</h4>
                                <div class="flex flex-wrap gap-1">
                                    ${turnsData.availableTurns.map(turn => 
                                        `<span class="bg-blue-200 text-blue-800 px-2 py-1 rounded text-sm">${turn}</span>`
                                    ).join('')}
                                </div>
                            </div>`;
                    }
                    
                    participantsList.innerHTML = participantsHTML;
                    document.getElementById('participantsModal').classList.remove('hidden');
                } else {
                    showMessage('Error obteniendo informaci√≥n de la tanda', 'error');
                }
            } catch (error) {
                showMessage('Error obteniendo participantes', 'error');
            }
        }

        function closeParticipantsModal() {
            document.getElementById('participantsModal').classList.add('hidden');
        }
    </script>
</body>
</html>
